const SMILE_RATIO_THRESHOLD = 1.7;
const MOUTH_CURVE_THRESHOLD = 0.015;
const FRAME_WINDOW = 5;

let smileBuffer = [];

faceMesh.onResults((results) => {
  if (!results.multiFaceLandmarks.length) {
    statusText.innerText = 'Face not detected';
    return;
  }

  const landmarks = results.multiFaceLandmarks[0];

  const left = landmarks[61];
  const right = landmarks[291];
  const top = landmarks[13];
  const bottom = landmarks[14];
  const cornerLeft = landmarks[78];
  const cornerRight = landmarks[308];

  const mouthWidth = Math.hypot(right.x - left.x, right.y - left.y);
  const mouthHeight = Math.hypot(bottom.x - top.x, bottom.y - top.y);
  const mouthCurve = ((cornerRight.y + cornerLeft.y) / 2) - top.y;

  const smileRatio = mouthWidth / mouthHeight;
  const isSmilingNow = (smileRatio > SMILE_RATIO_THRESHOLD) && (mouthCurve > MOUTH_CURVE_THRESHOLD);

  // Add to buffer
  smileBuffer.push(isSmilingNow);
  if (smileBuffer.length > FRAME_WINDOW) {
    smileBuffer.shift(); // keep buffer size
  }

  // Decide based on majority vote from buffer
  const smileCount = smileBuffer.filter(v => v).length;
  const isSmiling = smileCount > (FRAME_WINDOW / 2);

  statusText.innerText = isSmiling ? "ğŸ˜Š You're smiling!" : "ğŸ˜ Not smiling";

  canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
});
